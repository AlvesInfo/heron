{% extends "heron/base_semantic.html" %}

{% load static %}

{% block menu_principal %}
        {% include "heron/menu_principal.html" %}
{% endblock menu_principal %}

{% block content %}

{% if user.is_authenticated %}

        {% include 'edi/invoice_marchandise_empty_form.html' %}

{#        <form action="" method="post">#}
            {% csrf_token %}
            {% include "edi/invoice_marchandise_update_entete.html" %}
            {% include "edi/invoice_marchandise_update_table.html" %}
{#        </form>#}

    {% else %}

        <br>
        <br>
        <hr>
        <br>
        <br>
        <p style="text-align: center;">Vous devez être connecté, pour pouvoir utiliser ce
            site</p>

{% endif %}


{% endblock content %}

{% block script %}

    <script type="text/javascript">

        $(document).ready(function () {
            $(`.datatable-chargement`).hide();

            let nbDisplay = {{ nb_display }};

            $("#id_create_invoice").click(function (event) {
                let entete = {
                    'third_party_num':$(`#id_third_party_num`).dropdown('get value'),
                    'invoice_number':$(`#id_invoice_number`).val(),
                    'invoice_date':$(`#id_invoice_date`).val(),
                    'invoice_type':$(`#id_invoice_type`).dropdown('get value'),
                    'devise':$(`#id_devise`).dropdown('get value')
                };
                let lignes = [];
                let nbFull = 0;
                for (let i = 1; i < nbDisplay + 1; i++) {
                    let cctUuidIdentification = $(`#id_cct_uuid_identification_${i.toString().padStart(3, '0')}`).dropdown('get value');
                    if (cctUuidIdentification !== '') {
                        nbFull += 1
                        lignes.push({
                            'cct_uuid_identification' : cctUuidIdentification,
                            'client_name' :  $(`#id_client_name_${i.toString().padStart(3, '0')}`).val(),
                            'serial_number' :  $(`#id_serial_number_${i.toString().padStart(3, '0')}`).val(),
                            'reference_article' :  $(`#id_reference_article_${i.toString().padStart(3, '0')}`).val(),
                            'libelle' :  $(`#id_libelle_${i.toString().padStart(3, '0')}`).val(),
                            'qty' :  $(`#id_qty_${i.toString().padStart(3, '0')}`).val(),
                            'unit_weight' :  $(`#id_unit_weight_${i.toString().padStart(3, '0')}`).dropdown('get value'),
                            'net_unit_price' :  $(`#id_net_unit_price_${i.toString().padStart(3, '0')}`).val(),
                            'vat' :  $(`#id_vat_${i.toString().padStart(3, '0')}`).dropdown('get value'),
                            'j' : i.toString()
                        });
                    }
                }
                let formData = {
                    'csrfmiddlewaretoken' : $(`input[name*='csrfmiddlewaretoken']`).val(),
                    'entete': entete,
                    'lignes': lignes
                };

                console.log(nbFull, {'data': JSON.stringify(formData)})

                $.ajax({
                    type: "POST",
                    url: "{{ url_saisie }}",
                    data: {'data': JSON.stringify(formData)},
                    encode: true,
                }).done(function () {
                    console.log("RETOUR")
                });

                event.preventDefault();

            });

        });

    </script>

{% endblock script %}

