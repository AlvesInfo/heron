{% extends "heron/base_semantic.html" %}

{% load static %}
{% load filters_tags %}

{% block menu_principal %}
        {% include "heron/menu_principal.html" %}
{% endblock menu_principal %}

{% block content %}

    {% if user.is_authenticated %}
        <form action="" method="post" id="send_email_invoices">
            {% csrf_token %}
            {% include "invoices/send_email_invoices_entete.html" %}
            {% if not not_finalize %}
                {% include "invoices/send_email_invoices_table.html" %}
            {% endif %}
        </form>
        <div class="ui equal width grid center"></div>

    {% else %}

        <br>
        <br>
        <hr>
        <br>
        <br>
        <p style="text-align: center;">Vous devez Ãªtre connectÃ©, pour pouvoir utiliser ce
            site</p>

{% endif %}


{% endblock content %}

{% block script %}

    <script src="{% static 'progress_polling.js' %}"></script>

    <script>

        $(document).ready(function () {

            {% include "heron/base_data_table.html" %}

            // Variable pour stocker le bouton cliquÃ©
            let clickedButton = null;

            // Capturer quel bouton a Ã©tÃ© cliquÃ©
            $('button[type="submit"]').on('click', function() {
                clickedButton = $(this);
            });


            // Gestionnaire unifiÃ© pour la soumission du formulaire
            $(`#send_email_invoices`).on('submit', function (e) {
                e.preventDefault();

                // Masquer le bouton cliquÃ© immÃ©diatement
                if (clickedButton) {
                    clickedButton.hide();
                }

                // Masquer le formulaire et changer le titre
                $(`#import_launch`).hide();
                $(`#id_titre_table`).text("LANCEMENT PATIENTEZ ...").css("color", "teal");


                // RÃ©cupÃ©rer les donnÃ©es du formulaire
                const formData = new FormData(this);

                // Ajouter le nom du bouton cliquÃ© au POST
                if (clickedButton) {
                    const buttonName = clickedButton.attr('name');
                    const buttonValue = clickedButton.val() || buttonName;

                    if (buttonName) {
                        formData.append(buttonName, buttonValue);
                    }
                }

                // DÃ©terminer le titre et l'icÃ´ne en fonction du bouton cliquÃ©
                let title = 'Envoi Global, par mail des factures de vente';
                let icon = 'ðŸ§¾';


                // Envoyer la requÃªte AJAX
                $.ajax({
                    url: "{% url 'invoices:send_email_pdf_invoice' %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $(`#id_titre_table`).text("ENVOI DES FACTURES PAR MAIL EN COURS ...").css("color", "teal");

                            // Afficher le conteneur de progression
                            $(`#progress-container`).show();

                            // Initialiser la jauge de progression avec le titre dynamique
                            new ProgressPolling('progress-container', response.job_id, {
                                title: title,
                                icon: icon,
                                showDetails: true,
                                showStats: true,
                                pollInterval: 1000,  // 1 seconde pour les tÃ¢ches parallÃ¨les
                                debug: false,
                                onComplete: function (data) {
                                    $(`#id_titre_table`).text("ENVOI TERMINEE").css("color", "teal");
                                    $(`#integrations`).show();

                                    // Recharger la page aprÃ¨s 50 secondes
                                    /*
                                    setTimeout(function () {
                                        location.href = "{% url 'invoices:send_email_pdf_invoice' %}";
                                    }, 50000);
                                    */
                                },
                                onError: function (data) {
                                    $(`#id_titre_table`).text("ERREUR ...").css("color", "red");
                                    // Recharger la page en cas d'erreur
                                    /*
                                    setTimeout(function () {
                                        location.reload();
                                    }, 2000);
                                    */
                                }
                            });
                        } else {
                            location.reload();
                        }
                    },
                    error: function (xhr, status, error) {
                        location.reload();
                    }
                });
            });

            // slight update to account for browsers not supporting e.which
            function disableF5(e) { if ((e.which || e.keyCode) === 116) e.preventDefault(); }
            // To disable f5 jQuery >= 1.7
            $(document).on("keydown", disableF5);

            $(`.datatable-chargement`).hide();
        });

    </script>

{% endblock script %}
