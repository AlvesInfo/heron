# Code source complet du syst√®me de progression AJAX
# R√©f√©rence pour Claude Code
# Tous les fichiers n√©cessaires pour impl√©menter une jauge de progression

# ============================================================================
# MOD√àLE DJANGO
# ============================================================================
model_file:
  path: "apps/core/models/models_sse_progress.py"
  description: "Mod√®le Django pour stocker l'√©tat des jobs de progression"
  code: |
    """
    Mod√®le Django pour suivre la progression
    √Ä inclure dans apps/core/models/

    created at: 2025-01-10
    created by: Paulo ALVES
    """

    from django.db import models
    from django.utils import timezone
    from django.conf import settings


    class SSEProgress(models.Model):
        """
        Mod√®le g√©n√©rique pour suivre la progression de t√¢ches
        R√©utilisable pour n'importe quelle t√¢che (envoi emails, import, export, etc.)
        """

        job_id = models.CharField(
            max_length=100,
            unique=True,
            db_index=True,
            verbose_name="ID du job",
            help_text="Identifiant unique du job (UUID)",
        )

        user = models.ForeignKey(
            settings.AUTH_USER_MODEL,
            on_delete=models.CASCADE,
            related_name="sse_progress_jobs",
            verbose_name="Utilisateur",
        )

        STATUS_CHOICES = [
            ("pending", "En attente"),
            ("in_progress", "En cours"),
            ("completed", "Termin√©"),
            ("failed", "√âchou√©"),
        ]
        status = models.CharField(
            max_length=20,
            choices=STATUS_CHOICES,
            default="pending",
            verbose_name="Statut",
            db_index=True,
        )

        task_type = models.CharField(
            max_length=50,
            verbose_name="Type de t√¢che",
            help_text="email_sending, data_import, report_generation, etc.",
            db_index=True,
        )

        total_items = models.IntegerField(
            default=0,
            verbose_name="Nombre total d'√©l√©ments",
        )
        processed_items = models.IntegerField(
            default=0,
            verbose_name="√âl√©ments trait√©s",
        )
        failed_items = models.IntegerField(
            default=0,
            verbose_name="√âl√©ments en erreur",
        )

        current_message = models.CharField(
            max_length=500,
            blank=True,
            null=True,
            verbose_name="Message en cours",
        )

        error_message = models.TextField(
            blank=True,
            null=True,
            verbose_name="Message d'erreur",
        )

        metadata = models.JSONField(
            blank=True,
            null=True,
            verbose_name="M√©tadonn√©es",
            help_text="Donn√©es suppl√©mentaires sp√©cifiques au type de t√¢che",
        )

        created_at = models.DateTimeField(
            auto_now_add=True,
            verbose_name="Date de cr√©ation",
        )
        started_at = models.DateTimeField(
            blank=True,
            null=True,
            verbose_name="Date de d√©marrage",
        )
        completed_at = models.DateTimeField(
            blank=True,
            null=True,
            verbose_name="Date de fin",
        )

        class Meta:
            verbose_name = "Progression"
            verbose_name_plural = "Progressions"
            ordering = ["-created_at"]
            indexes = [
                models.Index(fields=["job_id"]),
                models.Index(fields=["status"]),
                models.Index(fields=["task_type"]),
                models.Index(fields=["user", "-created_at"]),
            ]

        def __str__(self):
            return f"{self.task_type} - {self.job_id} - {self.status} ({self.processed_items}/{self.total_items})"

        @property
        def progress_percentage(self):
            """Calcule le pourcentage de progression"""
            if self.total_items == 0:
                return 0
            return int((self.processed_items / self.total_items) * 100)

        @property
        def success_count(self):
            """Nombre d'√©l√©ments trait√©s avec succ√®s"""
            return self.processed_items - self.failed_items

        @property
        def success_rate(self):
            """Calcule le taux de succ√®s"""
            if self.processed_items == 0:
                return 0
            return int((self.success_count / self.processed_items) * 100)

        @property
        def duration(self):
            """Calcule la dur√©e du job en secondes"""
            if not self.started_at:
                return 0

            end_time = self.completed_at or timezone.now()
            duration = end_time - self.started_at
            return duration.total_seconds()

        @property
        def estimated_remaining_time(self):
            """Estime le temps restant en secondes"""
            if self.processed_items == 0 or self.duration == 0:
                return None

            remaining_items = self.total_items - self.processed_items
            if remaining_items <= 0:
                return 0

            avg_time_per_item = self.duration / self.processed_items
            return int(remaining_items * avg_time_per_item)

        @property
        def items_per_second(self):
            """Calcule le nombre d'√©l√©ments trait√©s par seconde"""
            if self.duration == 0 or self.processed_items == 0:
                return 0
            return round(self.processed_items / self.duration, 2)

        def mark_as_started(self):
            """Marque le job comme d√©marr√©"""
            self.status = "in_progress"
            self.started_at = timezone.now()
            self.save()

        def mark_as_completed(self):
            """Marque le job comme termin√©"""
            self.status = "completed"
            self.completed_at = timezone.now()
            self.save()

        def mark_as_failed(self, error_message=None):
            """Marque le job comme √©chou√©"""
            self.status = "failed"
            self.completed_at = timezone.now()
            if error_message:
                self.error_message = error_message
            self.save()

        def update_progress(self, processed=0, failed=0, message=None):
            """Met √† jour la progression"""
            self.processed_items += processed
            self.failed_items += failed

            if message:
                self.current_message = message

            self.save()

        def to_dict(self):
            """Convertit en dictionnaire pour l'API"""
            return {
                "job_id": self.job_id,
                "task_type": self.task_type,
                "status": self.status,
                "status_display": self.get_status_display(),
                "total_items": self.total_items,
                "processed_items": self.processed_items,
                "failed_items": self.failed_items,
                "success_count": self.success_count,
                "progress_percentage": self.progress_percentage,
                "success_rate": self.success_rate,
                "current_message": self.current_message,
                "error_message": self.error_message,
                "metadata": self.metadata,
                "created_at": self.created_at.isoformat() if self.created_at else None,
                "started_at": self.started_at.isoformat() if self.started_at else None,
                "completed_at": self.completed_at.isoformat() if self.completed_at else None,
                "duration": self.duration,
                "estimated_remaining_time": self.estimated_remaining_time,
                "items_per_second": self.items_per_second,
            }

# ============================================================================
# VUES API DJANGO
# ============================================================================
views_api_file:
  path: "apps/core/views/views_sse_progress.py"
  description: "Vues API REST pour r√©cup√©rer l'√©tat des jobs"
  code: |
    """
    Vues API pour le suivi de progression
    Endpoints pour r√©cup√©rer l'√©tat de jobs en cours

    created at: 2025-01-10
    created by: Paulo ALVES
    """

    from django.http import JsonResponse
    from django.views.decorators.http import require_http_methods
    from django.contrib.auth.decorators import login_required

    from apps.core.models import SSEProgress


    @login_required
    @require_http_methods(["GET"])
    def get_job_progress(request, job_id):
        """
        R√©cup√®re la progression d'un job sp√©cifique

        URL: /core/sse-progress/<job_id>/
        M√©thode: GET

        Returns:
            JSON avec les d√©tails du job ou erreur 404
        """
        try:
            progress = SSEProgress.objects.get(
                job_id=job_id,
                user=request.user
            )
            return JsonResponse(progress.to_dict())
        except SSEProgress.DoesNotExist:
            return JsonResponse(
                {"error": f"Job {job_id} non trouv√©"},
                status=404
            )


    @login_required
    @require_http_methods(["GET"])
    def get_user_jobs(request):
        """
        R√©cup√®re tous les jobs de l'utilisateur connect√©

        URL: /core/sse-progress/
        M√©thode: GET

        Query params optionnels:
            - task_type: Filtrer par type de t√¢che
            - status: Filtrer par statut
            - limit: Limiter le nombre de r√©sultats (d√©faut: 50)

        Returns:
            JSON avec la liste des jobs
        """
        queryset = SSEProgress.objects.filter(user=request.user)

        task_type = request.GET.get('task_type')
        if task_type:
            queryset = queryset.filter(task_type=task_type)

        status = request.GET.get('status')
        if status:
            queryset = queryset.filter(status=status)

        limit = int(request.GET.get('limit', 50))
        jobs = queryset[:limit]

        return JsonResponse({
            "count": jobs.count(),
            "jobs": [job.to_dict() for job in jobs]
        })


    @login_required
    @require_http_methods(["GET"])
    def get_active_jobs(request):
        """
        R√©cup√®re uniquement les jobs actifs (pending ou in_progress)

        URL: /core/sse-progress/active/
        M√©thode: GET

        Returns:
            JSON avec la liste des jobs actifs
        """
        jobs = SSEProgress.objects.filter(
            user=request.user,
            status__in=['pending', 'in_progress']
        ).order_by('-started_at')

        return JsonResponse({
            "count": jobs.count(),
            "jobs": [job.to_dict() for job in jobs]
        })


    @login_required
    @require_http_methods(["DELETE"])
    def delete_job(request, job_id):
        """
        Supprime un job termin√© ou √©chou√©

        URL: /core/sse-progress/<job_id>/delete/
        M√©thode: DELETE

        Returns:
            JSON confirmation ou erreur
        """
        try:
            progress = SSEProgress.objects.get(
                job_id=job_id,
                user=request.user
            )

            if progress.status in ['pending', 'in_progress']:
                return JsonResponse(
                    {"error": "Impossible de supprimer un job en cours"},
                    status=400
                )

            progress.delete()
            return JsonResponse({
                "success": True,
                "message": f"Job {job_id} supprim√©"
            })

        except SSEProgress.DoesNotExist:
            return JsonResponse(
                {"error": f"Job {job_id} non trouv√©"},
                status=404
            )

# ============================================================================
# URLS DJANGO
# ============================================================================
urls_file:
  path: "apps/core/urls.py"
  description: "Routes API pour le syst√®me de progression"
  code: |
    from django.urls import path

    from apps.core.views import (
        # API POUR LES JAUGES AJAX POLLING
        get_user_jobs,
        get_active_jobs,
        get_job_progress,
        delete_job,
    )

    urlpatterns = [
        # API POUR LES JAUGES AJAX POLLING
        path("sse-progress/", get_user_jobs, name="list_jobs"),
        path("sse-progress/active/", get_active_jobs, name="active_jobs"),
        path("sse-progress/<str:job_id>/", get_job_progress, name="job_detail"),
        path("sse-progress/<str:job_id>/delete/", delete_job, name="delete_job"),
    ]

# ============================================================================
# JAVASCRIPT - CLASSE PROGRESSPOLLING
# ============================================================================
javascript_file:
  path: "files/static/js/progress_polling.js"
  description: "Classe JavaScript pour le polling AJAX avec Semantic UI"
  code: |
    /**
     * Syst√®me de progression avec polling AJAX
     * Alternative simple et fiable au SSE
     *
     * @author Paulo ALVES
     * @date 2025-11-16
     */

    class ProgressPolling {
        constructor(containerId, jobId, options = {}) {
            this.container = document.getElementById(containerId);
            if (!this.container) {
                throw new Error(`Container ${containerId} introuvable`);
            }

            this.jobId = jobId;
            this.options = {
                pollInterval: options.pollInterval || 500, // Polling toutes les 500ms
                title: options.title || 'Progression',
                icon: options.icon || '‚è≥',
                showDetails: options.showDetails !== false,
                showStats: options.showStats !== false,
                autoHideOnComplete: options.autoHideOnComplete || false,
                autoHideDelay: options.autoHideDelay || 3000,
                debug: options.debug || false,
                onStart: options.onStart || null,
                onProgress: options.onProgress || null,
                onComplete: options.onComplete || null,
                onError: options.onError || null,
            };

            this.pollingTimer = null;
            this.isPolling = false;
            this.lastStatus = null;

            this.createUI();
            this.startPolling();
        }

        createUI() {
            this.container.innerHTML = `
                <div class="ui segment">
                    <div class="ui grid">
                        <div class="twelve wide column">
                            <h3 class="ui header">
                                <i class="progress-icon chart line icon"></i>
                                <div class="content">
                                    ${this.options.title}
                                    <div class="sub header progress-status">Chargement...</div>
                                </div>
                            </h3>
                        </div>
                        <div class="four wide column right aligned">
                            <div class="ui label progress-label">
                                <i class="clock outline icon"></i>
                                En attente
                            </div>
                        </div>
                    </div>

                    <div class="ui indicating progress" data-percent="0" id="progress-${this.jobId}">
                        <div class="bar">
                            <div class="progress"></div>
                        </div>
                        <div class="label">Initialisation...</div>
                    </div>

                    ${this.options.showDetails ? `
                    <div class="ui three column grid" style="margin-top: 15px;">
                        <div class="column">
                            <div class="ui statistic tiny">
                                <div class="value detail-total">-</div>
                                <div class="label">Total</div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="ui statistic tiny green">
                                <div class="value detail-current">-</div>
                                <div class="label">Trait√©s</div>
                            </div>
                        </div>
                        <div class="column">
                            <div class="ui statistic tiny">
                                <div class="value detail-remaining">-</div>
                                <div class="label">Restants</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${this.options.showStats ? `
                    <div class="ui message stat-message-container" style="margin-top: 15px;">
                        <i class="info circle icon"></i>
                        <span class="stat-message">R√©cup√©ration des donn√©es...</span>
                    </div>
                    ` : ''}
                </div>
            `;

            this.elements = {
                icon: this.container.querySelector('.progress-icon'),
                status: this.container.querySelector('.progress-status'),
                label: this.container.querySelector('.progress-label'),
                progressBar: $(`#progress-${this.jobId}`),
                total: this.container.querySelector('.detail-total'),
                current: this.container.querySelector('.detail-current'),
                remaining: this.container.querySelector('.detail-remaining'),
                message: this.container.querySelector('.stat-message'),
                messageContainer: this.container.querySelector('.stat-message-container'),
            };

            // Initialiser le composant progress de Semantic UI
            this.elements.progressBar.progress({
                percent: 0
            });
        }

        async startPolling() {
            this.isPolling = true;
            if (this.options.debug) {
                console.log(`[Polling] D√©marrage du polling pour job ${this.jobId}`);
            }
            await this.poll();
        }

        async poll() {
            if (!this.isPolling) return;

            try {
                const response = await fetch(`/core/sse-progress/${this.jobId}/`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (this.options.debug) {
                    console.log('[Polling] Donn√©es re√ßues:', data);
                }

                this.updateUI(data);

                // Continuer le polling si le job n'est pas termin√©
                if (data.status === 'in_progress' || data.status === 'pending') {
                    this.pollingTimer = setTimeout(() => this.poll(), this.options.pollInterval);
                } else {
                    this.stopPolling();
                }

            } catch (error) {
                console.error('[Polling] Erreur:', error);
                this.handleError(error.message);

                // Retry apr√®s un d√©lai plus long en cas d'erreur
                if (this.isPolling) {
                    this.pollingTimer = setTimeout(() => this.poll(), this.options.pollInterval * 2);
                }
            }
        }

        updateUI(data) {
            const percentage = data.progress_percentage || 0;
            const status = data.status;

            // Mettre √† jour la barre de progression Semantic UI
            this.elements.progressBar.progress('set percent', percentage);
            this.elements.progressBar.find('.label').text(
                `${data.processed_items || 0} / ${data.total_items || 0} items (${percentage}%)`
            );

            // Mettre √† jour les d√©tails
            if (this.elements.total) this.elements.total.textContent = data.total_items || 0;
            if (this.elements.current) this.elements.current.textContent = data.processed_items || 0;
            if (this.elements.remaining) {
                const remaining = (data.total_items || 0) - (data.processed_items || 0);
                this.elements.remaining.textContent = remaining;
            }

            // Mettre √† jour le statut
            switch (status) {
                case 'pending':
                    this.elements.icon.className = 'clock outline icon progress-icon';
                    this.elements.status.textContent = 'En attente de d√©marrage...';
                    this.elements.label.className = 'ui yellow label progress-label';
                    this.elements.label.innerHTML = '<i class="clock outline icon"></i> En attente';
                    if (this.elements.messageContainer) {
                        this.elements.messageContainer.className = 'ui info message stat-message-container';
                    }
                    if (this.elements.message) {
                        this.elements.message.textContent = 'En attente de d√©marrage...';
                    }
                    break;

                case 'in_progress':
                    if (this.lastStatus !== 'in_progress' && this.options.onStart) {
                        this.options.onStart(data);
                    }
                    this.elements.icon.className = 'spinner loading icon progress-icon';
                    this.elements.status.textContent = 'Traitement en cours...';
                    this.elements.label.className = 'ui blue label progress-label';
                    this.elements.label.innerHTML = '<i class="spinner loading icon"></i> En cours';
                    if (this.elements.messageContainer) {
                        this.elements.messageContainer.className = 'ui info message stat-message-container';
                    }
                    if (this.elements.message) {
                        this.elements.message.textContent = data.current_message || 'Traitement en cours...';
                    }
                    if (this.options.onProgress) {
                        this.options.onProgress(data);
                    }
                    break;

                case 'completed':
                    this.elements.icon.className = 'check circle icon progress-icon';
                    this.elements.status.textContent = 'Traitement termin√© avec succ√®s';
                    this.elements.label.className = 'ui green label progress-label';
                    this.elements.label.innerHTML = '<i class="check circle icon"></i> Termin√©';
                    this.elements.progressBar.progress('set success');
                    if (this.elements.messageContainer) {
                        this.elements.messageContainer.className = 'ui success message stat-message-container';
                    }
                    if (this.elements.message) {
                        this.elements.message.textContent = `Termin√© avec succ√®s ! (${data.duration}s)`;
                    }
                    if (this.options.onComplete) {
                        this.options.onComplete(data);
                    }
                    if (this.options.autoHideOnComplete) {
                        setTimeout(() => {
                            this.container.style.display = 'none';
                        }, this.options.autoHideDelay);
                    }
                    break;

                case 'failed':
                    this.elements.icon.className = 'exclamation triangle icon progress-icon';
                    this.elements.status.textContent = 'Une erreur est survenue';
                    this.elements.label.className = 'ui red label progress-label';
                    this.elements.label.innerHTML = '<i class="exclamation triangle icon"></i> Erreur';
                    this.elements.progressBar.progress('set error');
                    if (this.elements.messageContainer) {
                        this.elements.messageContainer.className = 'ui error message stat-message-container';
                    }
                    if (this.elements.message) {
                        this.elements.message.textContent = data.error_message || 'Une erreur est survenue';
                    }
                    if (this.options.onError) {
                        this.options.onError(data);
                    }
                    break;
            }

            this.lastStatus = status;
        }

        handleError(errorMessage) {
            this.elements.icon.className = 'warning circle icon progress-icon';
            this.elements.status.textContent = 'Probl√®me de connexion';
            this.elements.label.className = 'ui orange label progress-label';
            this.elements.label.innerHTML = '<i class="warning circle icon"></i> Erreur connexion';
            if (this.elements.messageContainer) {
                this.elements.messageContainer.className = 'ui warning message stat-message-container';
            }
            if (this.elements.message) {
                this.elements.message.textContent = `Erreur: ${errorMessage}. Nouvelle tentative...`;
            }
        }

        stopPolling() {
            this.isPolling = false;
            if (this.pollingTimer) {
                clearTimeout(this.pollingTimer);
                this.pollingTimer = null;
            }
            if (this.options.debug) {
                console.log('[Polling] Arr√™t du polling');
            }
        }

        destroy() {
            this.stopPolling();
            this.container.innerHTML = '';
        }
    }

    // Export pour utilisation en module
    if (typeof module !== 'undefined' && module.exports) {
        module.exports = { ProgressPolling };
    }

# ============================================================================
# SETTINGS DJANGO
# ============================================================================
settings_config:
  description: "Configuration dans heron/settings/base.py"
  code: |
    # ============================================================================
    # SYST√àME DE PROGRESSION EN TEMPS R√âEL (AJAX Polling)
    # ============================================================================
    # Le syst√®me utilise du polling AJAX pour afficher la progression des t√¢ches Celery
    # Les progressions sont stock√©es dans le mod√®le SSEProgress (apps/core/models)
    # Le frontend interroge l'API REST toutes les 500ms pour r√©cup√©rer l'√©tat
    # Documentation: apps/core/README_PROGRESS.md

# ============================================================================
# FICHIERS STATIQUES
# ============================================================================
static_files:
  javascript:
    path: "files/static/js/progress_polling.js"
    description: "Fichier JavaScript √† inclure dans les templates"
    load_in_template: |
      <script src="{% static 'js/progress_polling.js' %}"></script>

# ============================================================================
# EXEMPLE COMPLET D'UTILISATION
# ============================================================================
example_complete:
  description: "Exemple complet avec vue + t√¢che + template"

  vue:
    path: "apps/[app]/views/[fichier].py"
    code: |
      import uuid
      from django.shortcuts import render
      from django.http import JsonResponse
      from django.contrib.auth.decorators import login_required

      from apps.[app].tasks import ma_tache

      @login_required
      def ma_vue(request):
          if request.method == 'POST':
              job_id = str(uuid.uuid4())
              ma_tache.delay(job_id, request.user.id)
              return JsonResponse({'success': True, 'job_id': job_id})

          return render(request, '[app]/template.html')

  tache:
    path: "apps/[app]/tasks.py"
    code: |
      from celery import shared_task
      from apps.core.models import SSEProgress

      @shared_task(name="ma_tache")
      def ma_tache(job_id, user_id):
          progress = SSEProgress.objects.create(
              job_id=job_id,
              user_id=user_id,
              task_type='mon_type',
              total_items=100
          )

          progress.mark_as_started()

          for i in range(1, 101):
              # Traitement
              progress.update_progress(processed=1)

          progress.mark_as_completed()
          return {"status": "success", "job_id": job_id}

  template:
    path: "apps/[app]/templates/[app]/template.html"
    code: |
      {% extends "heron/base_semantic.html" %}
      {% load static %}

      {% block content %}
      <div class="ui container" style="margin-top: 30px;">
          <button id="btnLancer" class="ui primary button">Lancer</button>
          <div id="jauge" style="margin-top: 20px;"></div>
      </div>
      {% endblock %}

      {% block script %}
      <script src="{% static 'js/progress_polling.js' %}"></script>
      <script>
      $(document).ready(function() {
          $('#btnLancer').on('click', async function() {
              const btn = $(this);
              btn.addClass('loading disabled');

              const response = await fetch(window.location.href, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{ csrf_token }}'
                  }
              });

              const data = await response.json();

              if (data.success) {
                  btn.parent().hide();

                  new ProgressPolling('jauge', data.job_id, {
                      title: 'Mon traitement',
                      icon: 'üìä',
                      showDetails: true,
                      showStats: true,
                      debug: true,
                      onComplete: (result) => {
                          console.log('Termin√©!', result);
                      }
                  });
              }
          });
      });
      </script>
      {% endblock %}

  urls:
    path: "apps/[app]/urls.py"
    code: |
      from django.urls import path
      from apps.[app].views import ma_vue

      urlpatterns = [
          path('mon-url/', ma_vue, name='ma_vue'),
      ]